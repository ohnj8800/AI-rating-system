<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ä½œæ¥­æ‰¹æ”¹</title>

  <!-- æ ¸å¿ƒè³‡æº -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    /* å®Œæ•´è¤‡è£½ index.html çš„ CSS */
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --secondary-color: #06b6d4;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --text-light: #1e293b;
      --text-dark: #f1f5f9;
      --text-muted-light: #64748b;
      --text-muted-dark: #94a3b8;
      --border-light: #e2e8f0;
      --border-dark: #334155;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    * { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-light) 0%, #e2e8f0 100%); color: var(--text-light); min-height: 100vh; line-height: 1.6; }
    [data-theme="dark"] body { background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 100%); color: var(--text-dark); }
    .navbar { background: rgba(255, 255, 255, 0.95) !important; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-light); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
    [data-theme="dark"] .navbar { background: rgba(30, 41, 59, 0.95) !important; border-bottom-color: var(--border-dark); }
    .navbar-brand { font-weight: 700; font-size: 1.5rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .nav-link { font-weight: 500; position: relative; padding: 0.75rem 1rem !important; border-radius: 0.5rem; margin: 0 0.25rem; }
    .nav-link:hover { background: rgba(99, 102, 241, 0.1); color: var(--primary-color) !important; }
    .nav-link.active { background: var(--primary-color); color: white !important; }
    .nav-link.active::after { content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%); width: 80%; height: 2px; background: var(--primary-color); border-radius: 1px; }
    .theme-toggle { position: fixed; top: 6rem; right: 2rem; z-index: 999; width: 60px; height: 60px; border-radius: 50%; background: var(--card-light); border: 2px solid var(--border-light); box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; }
    .theme-toggle:hover { transform: translateY(-2px) scale(1.05); box-shadow: var(--shadow-xl); }
    [data-theme="dark"] .theme-toggle { background: var(--card-dark); border-color: var(--border-dark); }
    .main-container { padding: 3rem 0; min-height: calc(100vh - 200px); }
    .page-header { text-align: center; margin-bottom: 3rem; }
    .page-title { font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
    .page-subtitle { font-size: 1.2rem; color: var(--text-muted-light); font-weight: 400; }
    [data-theme="dark"] .page-subtitle { color: var(--text-muted-dark); }
    .main-card { background: var(--card-light); border-radius: 1.5rem; box-shadow: var(--shadow-xl); border: 1px solid var(--border-light); overflow: hidden; margin-bottom: 2rem; }
    [data-theme="dark"] .main-card { background: var(--card-dark); border-color: var(--border-dark); }
    .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; position: relative; overflow: hidden; }
    .card-header::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: shimmer 3s infinite; }
    @keyframes shimmer { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .card-title { font-size: 2rem; font-weight: 700; margin: 0; position: relative; z-index: 1; display: flex; align-items: center; gap: 0.75rem; }
    .title-icon { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .card-body { padding: 2.5rem; }
    .form-section { margin-bottom: 2rem; }
    .form-label { font-weight: 600; color: var(--text-light); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
    [data-theme="dark"] .form-label { color: var(--text-dark); }
    .form-select, .form-control { border: 2px solid var(--border-light); border-radius: 0.75rem; padding: 1rem; font-size: 1rem; background: var(--card-light); color: var(--text-light); transition: all 0.3s ease; }
    [data-theme="dark"] .form-select, [data-theme="dark"] .form-control { border-color: var(--border-dark); background: var(--card-dark); color: var(--text-dark); }
    .form-select:focus, .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25); }
    .upload-box { border: 2px dashed var(--border-light); padding: 3rem 2rem; text-align: center; border-radius: 1rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(6, 182, 212, 0.05)); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
    [data-theme="dark"] .upload-box { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(6, 182, 212, 0.1)); border-color: var(--border-dark); color: var(--text-muted-dark); }
    .upload-box:hover { border-color: var(--primary-color); background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(6, 182, 212, 0.1)); transform: translateY(-2px); }
    .upload-box::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%); border-radius: 50%; z-index: 0; }
    .upload-content { position: relative; z-index: 1; }
    .upload-icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; }
    .upload-text { font-size: 1.1rem; font-weight: 500; color: var(--text-muted-light); }
    [data-theme="dark"] .upload-text { color: var(--text-muted-dark); }
    .btn-section { text-align: center; margin: 2rem 0; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .btn { padding: 0.75rem 2rem; border-radius: 2rem; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: none; position: relative; overflow: hidden; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--primary-dark), var(--primary-color)); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-outline-secondary { background: transparent; border: 2px solid var(--border-light); color: var(--text-muted-light); }
    [data-theme="dark"] .btn-outline-secondary { border-color: var(--border-dark); color: var(--text-muted-dark); }
    .btn-outline-secondary:hover { background: var(--primary-color); border-color: var(--primary-color); color: white; transform: translateY(-2px); }
    .btn-outline-danger { background: transparent; border: 2px solid var(--danger-color); color: var(--danger-color); }
    .btn-outline-danger:hover { background: var(--danger-color); color: white; transform: translateY(-2px); }
    .preview-box, .feedback-box { background: var(--card-light); border: 2px solid var(--border-light); border-left: 4px solid var(--primary-color); border-radius: 1rem; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: 0.95rem; white-space: pre-wrap; color: var(--text-light); margin-top: 1rem; box-shadow: var(--shadow); }
    [data-theme="dark"] .preview-box, [data-theme="dark"] .feedback-box { background: var(--card-dark); border-color: var(--border-dark); color: var(--text-dark); }
    .result-header { font-weight: 600; color: var(--text-muted-light); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
    [data-theme="dark"] .result-header { color: var(--text-muted-dark); }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; display: none; }
    .loading-content { text-align: center; background: var(--card-light); padding: 3rem; border-radius: 1.5rem; box-shadow: var(--shadow-xl); border: 1px solid var(--border-light); }
    [data-theme="dark"] .loading-content { background: var(--card-dark); border-color: var(--border-dark); }
    .loading-spinner { width: 4rem; height: 4rem; border: 4px solid rgba(99, 102, 241, 0.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; margin-bottom: 1.5rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
    #toast-container { position: fixed; top: 2rem; right: 2rem; z-index: 1050; }
    .toast { border-radius: 1rem; box-shadow: var(--shadow-lg); border: none; }
    @media (max-width: 768px) {
      .theme-toggle { top: 5rem; right: 1rem; width: 50px; height: 50px; font-size: 1.2rem; }
      .page-title { font-size: 2rem; }
      .card-header { padding: 1.5rem; }
      .card-title { font-size: 1.5rem; }
      .card-body { padding: 1.5rem; }
      .btn-section { flex-direction: column; align-items: center; }
      .btn { width: 100%; max-width: 300px; }
      .upload-box { padding: 2rem 1rem; }
      .upload-icon { font-size: 2rem; }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    .slide-up { animation: slideUp 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <!-- ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="åˆ‡æ›ä¸»é¡Œ">
    <i class="fas fa-moon" id="theme-icon"></i>
  </button>

  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-graduation-cap me-2"></i>æ•™å¸«ç³»çµ±
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="assignment_mark.html">
              <i class="fas fa-users me-1"></i>ä½œæ¥­æ‰¹æ”¹
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="teacher_upload.html">
              <i class="fas fa-upload me-1"></i>ä½œæ¥­ç™¼å¸ƒ
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="classmember.html">
              <i class="fas fa-user-friends me-1"></i>èª²ç¨‹æˆå“¡ç®¡ç†
            </a>
          </li>
        </ul>
        <a href="homepage.html" class="btn btn-outline-danger">
          <i class="fas fa-sign-out-alt me-1"></i>ç™»å‡º
        </a>
      </div>
    </div>
  </nav>

  <!-- å³å´æ‰¹æ”¹é€²åº¦æ‡¸æµ®å…ƒä»¶ -->
  <div id="gradingProgressFloating" style="display:none; position:fixed; top:6rem; right:2rem; z-index:3000; min-width:280px; background:var(--card-light); border:2px solid var(--primary-color); border-radius:1.2rem; box-shadow:var(--shadow-xl); padding:1.5rem 2rem; text-align:center; font-size:1.1rem; transition:all 0.3s;">
    <div id="gradingProgressStatus" style="font-weight:700; color:var(--primary-color); font-size:1.2rem; margin-bottom:0.5rem;">
      <i class="fas fa-spinner fa-spin me-2"></i>æ‰¹æ”¹é€²åº¦
    </div>
    <div id="gradingProgressText"></div>
    <div id="gradingProgressFile" style="margin-top:0.5rem; color:var(--primary-color); font-weight:600;"></div>
    <div id="gradingProgressEta" style="margin-top:0.5rem; color:var(--text-muted-light); font-size:0.95rem;"></div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container main-container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="page-header fade-in">
      <h1 class="page-title">ä½œæ¥­æ‰¹æ”¹</h1>
      <p class="page-subtitle">ä¸Šå‚³å­¸ç”Ÿç¨‹å¼ç¢¼ï¼ŒAI å³æ™‚æ‰¹æ”¹èˆ‡å›é¥‹</p>
    </div>

    <!-- ä¸»è¦å¡ç‰‡ -->
    <div class="main-card slide-up">
      <div class="card-header">
        <h2 class="card-title">
          <div class="title-icon">
            <i class="fas fa-users"></i>
          </div>
          ä½œæ¥­æ‰¹æ”¹ç³»çµ±
        </h2>
      </div>

      <div class="card-body">
        <!-- é¡Œç›®é¸æ“‡ -->
        <div class="form-section">
          <label class="form-label">
            <i class="fas fa-book"></i>
            é¸æ“‡é¡Œç›®
          </label>
          <select id="problemSelect" class="form-select">
            <option value="">è«‹é¸æ“‡é¡Œç›®</option>
          </select>
        </div>

       
        <!-- ä¸Šå‚³æ¨¡å¼ï¼ˆå–®ç¨ï¼è³‡æ–™å¤¾ã€æ‰¹é‡ï¼å¤šæª”ï¼‰ -->
        <div class="form-section">
          <label class="form-label">
            <i class="fas fa-list-check"></i>
            ä¸Šå‚³æ¨¡å¼
          </label>
          <div class="btn-group" role="group" aria-label="ä¸Šå‚³æ¨¡å¼" id="modeGroup">
            <input type="radio" class="btn-check" name="uploadMode" id="modeSingle" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="modeSingle">
              <i class="fas fa-folder-open me-1"></i> å–®ç¨ä¸Šå‚³ï¼ˆè³‡æ–™å¤¾ï¼‰
            </label>

            <input type="radio" class="btn-check" name="uploadMode" id="modeBatch" autocomplete="off">
            <label class="btn btn-outline-secondary" for="modeBatch">
              <i class="fas fa-files me-1"></i> æ‰¹é‡ä¸Šå‚³ï¼ˆå¤šæª”ï¼‰
            </label>
          </div>
        </div>
        <!-- AI è©•åˆ†æ¨¡å‹ -->
        <div class="form-section" id="llmRow">
          <label for="llmProvider" class="form-label">
            <i class="fas fa-robot"></i> AI è©•åˆ†æ¨¡å‹
          </label>
          <select id="llmProvider" class="form-select" style="max-width:260px;">
            <option value="gemini">Geminiï¼ˆé›²ç«¯ï¼‰</option>
            <option value="codellama" selected>Code Llamaï¼ˆæœ¬æ©Ÿï¼‰</option>
          </select>
        </div>


        <!-- ä¸Šå‚³æª”æ¡ˆ -->
        <div class="form-section">
          <label class="form-label">
            <i class="fas fa-cloud-upload-alt"></i>
            ä¸Šå‚³ç¨‹å¼ç¢¼æª”æ¡ˆ
          </label>
          <div style="display: flex; gap: 2rem; align-items: flex-start;">
            <label for="fileInput" class="upload-box" id="uploadLabel">
              <div class="upload-content">
                <div class="upload-icon">
                  <i class="fas fa-file-code"></i>
                </div>
                <div class="upload-text">
                  æ‹–æ›³æˆ–é»æ“Šé€™è£¡ä¸Šå‚³æª”æ¡ˆ<br>
                  <small>æ”¯æ´ .py, .js, .cpp, .java, .txt ç­‰æ ¼å¼</small>
                </div>
              </div>
              <input type="file" id="fileInput" accept=".py,.js,.java,.cpp,.txt" hidden multiple>
            </label>
            <div id="fileListBox" style="min-width:180px;">
              <strong>å·²é¸æª”æ¡ˆï¼š</strong>
              <ul id="fileList" style="margin:0; padding-left:1.2em;"></ul>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="btn-section">
          <button class="btn btn-primary" onclick="gradeCode()">
            <i class="fas fa-paper-plane me-2"></i>æ‰¹æ”¹ä¸¦å›é¥‹
          </button>
        </div>

        <!-- AI å›é¥‹å€åŸŸ -->
        <div id="feedbackBoxContainer" class="d-none">
          <h6 class="result-header">
            <i class="fas fa-robot"></i>
            AI æ‰¹æ”¹èˆ‡å›é¥‹
          </h6>
          <div id="feedbackBox" class="feedback-box"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast å®¹å™¨ -->
  <div id="toast-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // DOM å…ƒç´ 
    const fileInput = document.getElementById("fileInput");
    const feedbackBox = document.getElementById("feedbackBox");
    const feedbackContainer = document.getElementById("feedbackBoxContainer");
    const fileList = document.getElementById("fileList");
    const modeSingle = document.getElementById('modeSingle');
    const modeBatch = document.getElementById('modeBatch');

    // æª”æ¡ˆä¸Šå‚³è™•ç†
    let uploadedFiles = [];

    fileInput.addEventListener("change", function () {
      const allowed = new Set([".py", ".js", ".java", ".cpp", ".c", ".txt"]);
      const isFolderMode = modeSingle.checked;

      const files = Array.from(this.files || []);
      if (files.length === 0) {
        uploadedFiles = [];
        fileList.innerHTML = "";
        return;
      }

      if (isFolderMode) {
        // æª¢æŸ¥æ˜¯å¦åŒä¸€å€‹æ ¹è³‡æ–™å¤¾ï¼ˆä¾ webkitRelativePath çš„ç¬¬ä¸€æ®µï¼‰
        const relPaths = files.map(f => f.webkitRelativePath || f.name);
        const roots = relPaths.map(p => (p.includes("/") ? p.split("/")[0] : ""));
        const uniqueRoots = Array.from(new Set(roots.filter(r => r !== "")));
        if (uniqueRoots.length > 1) {
          showToast(`è«‹é¸æ“‡ã€ŒåŒä¸€å€‹ã€è³‡æ–™å¤¾ï¼ˆç›®å‰åµæ¸¬åˆ° ${uniqueRoots.length} å€‹ï¼‰`, "danger");
          uploadedFiles = [];
          fileList.innerHTML = "";
          fileInput.value = "";
          return;
        }

        // éæ¿¾å‰¯æª”å
        const filtered = files.filter(f => {
          const ext = (f.name.match(/\.[^.]+$/)?.[0] || "").toLowerCase();
          return allowed.has(ext);
        });
        const dropped = files.length - filtered.length;
        uploadedFiles = filtered;

        // é¡¯ç¤ºç›¸å°è·¯å¾‘ï¼Œè®“è€å¸«çœ‹åˆ°è³‡æ–™å¤¾çµæ§‹
        fileList.innerHTML = uploadedFiles
          .map(f => `<li>${f.webkitRelativePath || f.name}</li>`)
          .join("");

        let msg = `è³‡æ–™å¤¾å…§æ‰¾åˆ° ${uploadedFiles.length} å€‹å¯ç”¨æª”æ¡ˆ`;
        if (dropped > 0) msg += `ï¼ˆå·²å¿½ç•¥ ${dropped} å€‹ä¸æ”¯æ´çš„å‰¯æª”åï¼‰`;
        showToast(msg, "success");
      } else {
        // æ‰¹é‡ä¸Šå‚³ï¼ˆå¤šæª”ï¼‰æ¨¡å¼
        const filtered = files.filter(f => {
          const ext = (f.name.match(/\.[^.]+$/)?.[0] || "").toLowerCase();
          return allowed.has(ext);
        });
        const dropped = files.length - filtered.length;
        uploadedFiles = filtered;

        fileList.innerHTML = uploadedFiles.map(f => `<li>${f.name}</li>`).join("");
        let msg = `å·²é¸æ“‡ ${uploadedFiles.length} å€‹æª”æ¡ˆ`;
        if (dropped > 0) msg += `ï¼ˆå·²å¿½ç•¥ ${dropped} å€‹ä¸æ”¯æ´çš„å‰¯æª”åï¼‰`;
        showToast(msg, "success");
      }
    });



    // ä¾æ¨¡å¼åˆ‡æ› input.multiple èˆ‡ä¸Šå‚³æç¤ºæ–‡æ¡ˆ
    function applyUploadMode() {
      const isFolderMode = modeSingle.checked; // å–®ç¨ä¸Šå‚³ = ä¸Šå‚³ä¸€å€‹è³‡æ–™å¤¾

      // é‡ç½®ç‹€æ…‹
      uploadedFiles = [];
      fileInput.value = "";
      fileList.innerHTML = "";

      if (isFolderMode) {
        // è³‡æ–™å¤¾é¸æ“‡ï¼ˆChrome/Edge/Opera æ”¯æ´ï¼›Firefox è«‹ç”¨æ‹–æ›³è³‡æ–™å¤¾ï¼‰
        fileInput.setAttribute('webkitdirectory', '');
        fileInput.setAttribute('directory', '');
        fileInput.multiple = true; // è³‡æ–™å¤¾å…§æœƒæœ‰å¤šæª”
        document.querySelector('#uploadLabel .upload-text').innerHTML =
          'æ‹–æ›³æˆ–é»æ“Šé€™è£¡ä¸Šå‚³<b>æ•´å€‹è³‡æ–™å¤¾</b><br><small>æœƒè‡ªå‹•æ“·å– .py, .js, .cpp, .c, .java, .txt</small>';
      } else {
        // æ‰¹é‡æ¨¡å¼ï¼šä¸€èˆ¬å¤šæª”
        fileInput.removeAttribute('webkitdirectory');
        fileInput.removeAttribute('directory');
        fileInput.multiple = true;
        document.querySelector('#uploadLabel .upload-text').innerHTML =
          'æ‹–æ›³æˆ–é»æ“Šé€™è£¡ä¸Šå‚³æª”æ¡ˆï¼ˆå¯å¤šé¸ï¼‰<br><small>æ”¯æ´ .py, .js, .cpp, .c, .java, .txt ç­‰æ ¼å¼</small>';
      }
    }


    // è®“åˆ‡æ›çœŸçš„ç”Ÿæ•ˆï¼ˆä½ ç›®å‰æª”æ¡ˆæ²’æœ‰é€™ä¸‰è¡Œï¼‰
    modeSingle.addEventListener('change', applyUploadMode);
    modeBatch.addEventListener('change', applyUploadMode);
    applyUploadMode(); // é é¢è¼‰å…¥å…ˆå¥—ä¸€æ¬¡ï¼ˆé è¨­å–®ç¨ï¼è³‡æ–™å¤¾ï¼‰


    // è¼‰å…¥ä¿å­˜çš„ä¸»é¡Œ
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      html.setAttribute('data-theme', savedTheme);
      themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // å„ªåŒ–å¾Œçš„æ‰¹æ”¹é€²åº¦å…ƒä»¶æ§åˆ¶
    function showGradingProgress(finished, total, status, filename, etaSec) {
      const floating = document.getElementById('gradingProgressFloating');
      const text = document.getElementById('gradingProgressText');
      const fileDiv = document.getElementById('gradingProgressFile');
      const etaDiv = document.getElementById('gradingProgressEta');
      const statusDiv = document.getElementById('gradingProgressStatus');

      // ç‹€æ…‹åœ–ç¤º
      let statusIcon = "â³";
      let statusText = "æ’éšŠä¸­";
      if (status === "running") {
        statusIcon = "ğŸ”„";
        statusText = "æ‰¹æ”¹ä¸­";
      } else if (status === "done") {
        statusIcon = "âœ…";
        statusText = "å·²å®Œæˆ";
      }
      statusDiv.innerHTML = `<span style="font-size:1.5rem;">${statusIcon}</span> ${statusText}ï¼ˆ${finished}/${total}ï¼‰`;

      // é€²åº¦æ–‡å­—
      text.innerHTML = `å·²å®Œæˆ <b>${finished}</b> / <b>${total}</b>`;

      // ç›®å‰è™•ç†æª”æ¡ˆ
      if (filename) {
        fileDiv.textContent = `ç›®å‰è™•ç†ï¼š${filename}`;
        fileDiv.style.display = "";
      } else {
        fileDiv.style.display = "none";
      }

      // å‰©é¤˜æ™‚é–“ä¼°è¨ˆ
      if (etaSec !== undefined && etaSec !== null && !isNaN(etaSec)) {
        let etaStr = "";
        if (etaSec < 60) {
          etaStr = `${Math.round(etaSec)} ç§’`;
        } else {
          etaStr = `${Math.floor(etaSec / 60)} åˆ† ${Math.round(etaSec % 60)} ç§’`;
        }
        etaDiv.textContent = `é ä¼°å‰©é¤˜æ™‚é–“ï¼š${etaStr}`;
        etaDiv.style.display = "";
      } else {
        etaDiv.style.display = "none";
      }
      floating.style.display = '';
    }
    function hideGradingProgress() {
      document.getElementById('gradingProgressFloating').style.display = 'none';
    }

    // æ‰¹æ”¹åŠŸèƒ½
    async function gradeCode() {
      const selectedProblemId = document.getElementById("problemSelect").value;
        if (!selectedProblemId) {
          showToast("è«‹é¸æ“‡é¡Œç›®", "danger");
          return;
        }
        if (uploadedFiles.length === 0) {
          showToast("è«‹å…ˆä¸Šå‚³è‡³å°‘ä¸€å€‹æª”æ¡ˆ", "danger");
          return;
        }

        if (modeSingle.checked) {
          await gradeCodeSingle(Number(selectedProblemId));
        } else {
          await gradeCodeBatch(Number(selectedProblemId));
        }
    }

    async function gradeCodeSingle(problemId) {
      // å–®ç¨ä¸Šå‚³ï¼ä¸Šå‚³ä¸€å€‹è³‡æ–™å¤¾ï¼Œå¯¦éš›ä¸Šä¹Ÿæ˜¯é€ /batch_grade
      const token = localStorage.getItem("token");
      if (!uploadedFiles || uploadedFiles.length === 0) {
        showToast("è«‹å…ˆé¸æ“‡ä¸€å€‹è³‡æ–™å¤¾", "danger");
        return;
      }

      feedbackBox.textContent = "";
      feedbackContainer.classList.remove("d-none");

      // æº–å‚™ payloadï¼šæŠŠè³‡æ–™å¤¾å…§æ‰€æœ‰æª”æ¡ˆä¸€å€‹å€‹è®€é€²ä¾†
      const filesPayload = await Promise.all(
        uploadedFiles.map(async f => {
          const code = await f.text();
          return {
            filename: f.name,     // ç”¨å‰¯æª”åè®“å¾Œç«¯é¸å·¥å…·éˆ
            code,
            problem_id: problemId
          };
        })
      );

      // å–è³‡æ–™å¤¾ååšæç¤º
      let folderHint = "";
      const firstRel = uploadedFiles[0].webkitRelativePath || uploadedFiles[0].name;
      if (firstRel.includes("/")) folderHint = firstRel.split("/")[0];

      let taskId;
      try {
        const provider = document.getElementById("llmProvider").value;
        const res = await fetch(`http://localhost:8000/batch_grade?model=${provider}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ files: filesPayload })
        });

        const body = await res.json();
        if (!res.ok) {
          showToast("æäº¤æ‰¹æ”¹ä»»å‹™å¤±æ•—", "danger");
          feedbackBox.textContent = `â— æäº¤ä»»å‹™éŒ¯èª¤ï¼š${body.detail || JSON.stringify(body)}`;
          return;
        }
        taskId = body.task_id;
        showToast(`å·²å»ºç«‹æ‰¹æ”¹ä»»å‹™${folderHint ? `ï¼ˆè³‡æ–™å¤¾ï¼š${folderHint}ï¼‰` : ""}`, "success");
        showGradingProgress(0, filesPayload.length, "running", folderHint ? `${folderHint}/...` : "");
      } catch (e) {
        showToast("ç„¡æ³•é€å‡ºæ‰¹æ”¹ä»»å‹™", "danger");
        return;
      }

      // è¼ªè©¢ç‹€æ…‹ï¼ˆæ²¿ç”¨ä½ æ‰¹é‡ç‰ˆæœ¬ï¼‰
      const pollInterval = 2000;
      let lastFinished = 0, lastTime = Date.now(), avgTimePerFile = null;

      const polling = setInterval(async () => {
        try {
          const s = await fetch(`http://localhost:8000/batch_grade/status/${taskId}`);
          const data = await s.json();
          if (!s.ok) throw new Error("status fetch error");

          const total = data.total || filesPayload.length;
          const finished = data.finished || 0;
          const status = data.status || "pending";

          // ETA ç²—ä¼°
          let etaSec = null;
          if (finished > 0) {
            const now = Date.now();
            const elapsed = (now - lastTime) / 1000;
            const delta = finished - lastFinished;
            if (delta > 0) {
              avgTimePerFile = elapsed / delta;
              lastFinished = finished;
              lastTime = now;
            }
            if (avgTimePerFile) etaSec = avgTimePerFile * (total - finished);
          }

          // é¡¯ç¤ºç›®å‰æª”åï¼ˆç›¸å°è·¯å¾‘ï¼‰
          let filename = "";
          if (data.results && data.results.length < total && data.results.length >= 0) {
            const nextIdx = data.results.length;
            if (filesPayload[nextIdx]) {
              filename = (uploadedFiles[nextIdx].webkitRelativePath || filesPayload[nextIdx].filename);
            }
          }
          showGradingProgress(finished, total, status, filename, etaSec);

          if ((data.status === "done" && (data.finished || 0) >= (data.total || filesPayload.length))|| data.status === "not_found") {
            clearInterval(polling);
            hideGradingProgress();
            if (data.status === "not_found") {
              showToast("æ‰¾ä¸åˆ°æ‰¹æ”¹ä»»å‹™çµæœ", "danger");
              feedbackBox.textContent = "æ‰¾ä¸åˆ°è©²æ‰¹æ”¹ä»»å‹™çš„çµæœã€‚";
              return;
            }
            // ç”¨ä½ åŸæœ¬çš„çµæœè¼¸å‡ºé¢¨æ ¼
            feedbackBox.textContent = "";
            for (const r of data.results || []) {
              if (r.error) {
                feedbackBox.textContent += `\n--- [${r.filename}] ---\néŒ¯èª¤: ${r.error}\n`;
                continue;
              }
              const passCount = (r.detailed_results || []).filter(x => x.correct).length;
              const totalCases = (r.detailed_results || []).length;
              const passRate = totalCases ? ((passCount / totalCases) * 100).toFixed(1) : "0.0";
              feedbackBox.textContent += `\n--- [${r.filename}] ---\nAI åˆ†æ•¸: ${r.ai_score}\næ¸¬è³‡é€šé: ${passCount}/${totalCases} (${passRate}%)\nå›é¥‹:\n${r.ai_feedback}\n`;
            }
            feedbackContainer.classList.remove("d-none");
            feedbackContainer.scrollIntoView({ behavior: 'smooth' });
            showToast("è³‡æ–™å¤¾æ‰¹æ”¹å®Œæˆï¼Œçµæœå·²åœ¨å¾Œç«¯å„²å­˜", "success");
            exportResults(data.results, "xlsx");
          }
        } catch (err) {
          clearInterval(polling);
          hideGradingProgress();
          showToast("è¼ªè©¢æ‰¹æ”¹ç‹€æ…‹å¤±æ•—", "danger");
        }
      }, pollInterval);
    }


    async function gradeCodeBatch(problemId) {
      const token = localStorage.getItem("token");
      feedbackBox.textContent = "";
      feedbackContainer.classList.remove("d-none");

      const filesPayload = await Promise.all(uploadedFiles.map(async f => {
        const code = await f.text();
        return { filename: f.name, code, problem_id: problemId };
      }));

      let taskId;
      try {
        const provider = document.getElementById("llmProvider").value;
        const res = await fetch(`http://localhost:8000/batch_grade?model=${provider}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ files: filesPayload })
        });
        const body = await res.json();
        if (!res.ok) {
          showToast("æäº¤æ‰¹æ”¹ä»»å‹™å¤±æ•—", "danger");
          feedbackBox.textContent = `â— æäº¤ä»»å‹™éŒ¯èª¤ï¼š${body.detail || JSON.stringify(body)}`;
          return;
        }
        taskId = body.task_id;
        showToast("å·²å»ºç«‹æ‰¹æ”¹ä»»å‹™ï¼Œé–‹å§‹åœ¨ä¼ºæœå™¨å¾Œå°è™•ç†", "success");
        showGradingProgress(0, filesPayload.length);
      } catch (e) {
        showToast("ç„¡æ³•é€å‡ºæ‰¹æ”¹ä»»å‹™", "danger");
        return;
      }

      // è¼ªè©¢ï¼ˆä¿®æ­£ç‚º path åƒæ•¸ï¼‰
      const pollInterval = 2000;
      let lastFinished = 0;
      let lastTime = Date.now();
      let avgTimePerFile = null;
      const polling = setInterval(async () => {
        try {
          const s = await fetch(`http://localhost:8000/batch_grade/status/${taskId}`);
          const data = await s.json();
          if (s.ok) {
            const total = data.total || filesPayload.length;
            const finished = data.finished || 0;
            const status = data.status || "pending";
            let filename = "";
            if (data.results && data.results.length < total && data.results.length > 0) {
              const nextIdx = data.results.length;
              if (filesPayload[nextIdx]) filename = filesPayload[nextIdx].filename;
            }
            // ETA ç²—ä¼°
            let etaSec = null;
            if (finished > 0) {
              const now = Date.now();
              const elapsed = (now - lastTime) / 1000;
              const delta = finished - lastFinished;
              if (delta > 0) {
                avgTimePerFile = elapsed / delta;
                lastFinished = finished;
                lastTime = now;
              }
              if (avgTimePerFile) {
                etaSec = avgTimePerFile * (total - finished);
              }
            }
            showGradingProgress(finished, total, status, filename, etaSec);

            if ((data.status === "done" && (data.finished || 0) >= (data.total || filesPayload.length)) || data.status === "not_found") {
              clearInterval(polling);
              hideGradingProgress();
              if (data.status === "not_found") {
                showToast("æ‰¾ä¸åˆ°æ‰¹æ”¹ä»»å‹™çµæœ", "danger");
                feedbackBox.textContent = "æ‰¾ä¸åˆ°è©²æ‰¹æ”¹ä»»å‹™çš„çµæœã€‚";
                return;
              }
              // é¡¯ç¤ºæ‰¹é‡çµæœï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„æ ¼å¼ï¼‰
              feedbackBox.textContent = "";
              for (const r of data.results || []) {
                if (r.error) {
                  feedbackBox.textContent += `\n--- [${r.filename}] ---\néŒ¯èª¤: ${r.error}\n`;
                  continue;
                }
                const passCount = (r.detailed_results || []).filter(x => x.correct).length;
                const totalCases = (r.detailed_results || []).length;
                const passRate = totalCases ? ((passCount / totalCases) * 100).toFixed(1) : "0.0";
                feedbackBox.textContent += `\n--- [${r.filename}] ---\nAI åˆ†æ•¸: ${r.ai_score}\næ¸¬è³‡é€šé: ${passCount}/${totalCases} (${passRate}%)\nå›é¥‹:\n${r.ai_feedback}\n`;
              }
              feedbackContainer.classList.remove("d-none");
              feedbackContainer.scrollIntoView({ behavior: 'smooth' });
              showToast("æ‰¹æ”¹å®Œæˆï¼Œçµæœå·²åœ¨å¾Œç«¯å„²å­˜", "success");
              exportResults(data.results, "xlsx");
            }
          } else {
            clearInterval(polling);
            hideGradingProgress();
            showToast("å–å¾—æ‰¹æ”¹ç‹€æ…‹å¤±æ•—", "danger");
          }
        } catch (err) {
          clearInterval(polling);
          hideGradingProgress();
          showToast("è¼ªè©¢æ‰¹æ”¹ç‹€æ…‹å¤±æ•—", "danger");
        }
      }, pollInterval);
    }


    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
      toast.role = "alert";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.getElementById("toast-container").appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // åˆå§‹åŒ–ä¸»é¡Œèˆ‡é¡Œç›®
    document.addEventListener("DOMContentLoaded", async function () {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        document.documentElement.setAttribute("data-theme", savedTheme);
      }
      // é¡Œç›®è¼‰å…¥
      try {
        const res = await fetch("http://localhost:8000/api/problems/");
        const problems = await res.json();
        const problemSelect = document.getElementById("problemSelect");
        problems.forEach(problem => {
          const option = document.createElement("option");
          option.value = problem.id;
          option.textContent = problem.title;
          problemSelect.appendChild(option);
        });
      } catch (error) {
        showToast("ç„¡æ³•è¼‰å…¥é¡Œç›®åˆ—è¡¨", "danger");
      }
    });

    // === åŒ¯å‡ºæˆ Excel æˆ– TXT ===
    function exportResults(results, format = "xlsx") {
        if (!results || results.length === 0) {
            showToast("æ²’æœ‰å¯åŒ¯å‡ºçš„æ‰¹æ”¹çµæœ", "danger");
            return;
        }

        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, "-");
        const filename = `grading_results_${timestamp}`;

        // æ•´ç†æˆè¡¨æ ¼è³‡æ–™
        const rows = results.map(r => ({
            æª”å: r.filename || "",
            åˆ†æ•¸: r.ai_score ?? "",
            å›é¥‹: r.ai_feedback?.replace(/\n/g, " ") ?? "",
            æ‰¹æ”¹æ™‚é–“: now.toLocaleString(),
        }));

        if (format === "xlsx") {
            // ä½¿ç”¨ SheetJS åŒ¯å‡º Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "æ‰¹æ”¹çµæœ");
            XLSX.writeFile(wb, `${filename}.xlsx`);
            showToast("å·²åŒ¯å‡º Excel æª”", "success");
        } else {
            // åŒ¯å‡ºç´”æ–‡å­—
            const text = rows.map(r => 
                `æª”å: ${r.æª”å}\nåˆ†æ•¸: ${r.åˆ†æ•¸}\nå›é¥‹: ${r.å›é¥‹}\næ™‚é–“: ${r.æ‰¹æ”¹æ™‚é–“}\n---`
            ).join("\n\n");
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${filename}.txt`;
            a.click();
            showToast("å·²åŒ¯å‡º TXT æª”", "success");
        }
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>